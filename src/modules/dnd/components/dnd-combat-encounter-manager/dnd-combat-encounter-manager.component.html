<div class="page-wrapper">
  <div class="actions-wrapper">
    <button mat-icon-button (click)="addMonster()"><mat-icon>add</mat-icon></button>
    <button mat-icon-button (click)="toggleLogs()"><mat-icon>list</mat-icon></button>
    <button mat-icon-button (click)="togglePlayerView()"><mat-icon>visibility</mat-icon></button>
    <button mat-icon-button (click)="completeCombat()"><mat-icon>close</mat-icon></button>
    <button mat-icon-button (click)="restTheParty()"><mat-icon>replay</mat-icon></button>
  </div>
  <div class="initiative-wrapper">
    <div class="initiative mat-elevation-z8" *ngFor="let init of initiativeOrder; let i = index; trackBy:trackInit" [ngClass]="{'is-pc': init.isPC, 'is-dead': init.currentHPs <= 0, 'current-turn': init.hasCurrentTurn}">

      <ng-container *ngIf="!playerView">
        <div class="hp-meter mat-elevation-z8" [ngClass]="{'is-blooded': (init.currentHPs / init.maxHPs) <= 0.5, 'is-dead': init.currentHPs <= 0}">
          <div class="current-hp-meter" [ngStyle]="{'width': (init.currentHPs / init.maxHPs) * 100 + '%'}"></div>
          <div class="temp-hp-meter" [ngStyle]="{'width': (init.tempHPs / init.maxHPs) * 100 + '%'}"></div>
        </div>
      </ng-container>
      <ng-container *ngIf="playerView">
        <div class="hp-meter mat-elevation-z8" [ngClass]="{'is-blooded': (init.currentHPs / init.maxHPs) <= 0.5, 'is-dead': init.currentHPs <= 0}">
          <div class="current-hp-meter" [ngStyle]="{'width': '100%'}"></div>
        </div>
      </ng-container>

      <span class="name">{{init.name || init.defaultName}}</span>
      <div class="image">
        <ng-container *ngIf="init.isPC">
          <img [src]="'assets/images/dnd/player-characters/' + init.code + '.png'" />
        </ng-container>
        <ng-container *ngIf="!init.isPC">
          <img [src]="'assets/images/dnd/player-characters/' + (!!init.monsterType? init.monsterType: 'monster') + '.png'" />
        </ng-container>

        <mat-icon *ngIf="!!init.monsterType" class="icon-view" (click)="showStatblock(init)">visibility</mat-icon>
      </div>
      <div class="details">
        <div><mat-icon class="icon-temp-hps">heart_broken</mat-icon>{{init.tempHPs}}</div>
        <div><mat-icon class="icon-hps">favorite</mat-icon>{{init.currentHPs}}</div>
        <div><mat-icon class="icon-max-hps">favorite</mat-icon>{{init.maxHPs}}</div>
        <div><mat-icon class="icon-perc">hearing</mat-icon>{{init.passivePerception}}</div>
        <div><mat-icon class="icon-inv">visibility</mat-icon>{{init.passiveInvestigation}}</div>
      </div>
      <div class="ac" *ngIf="!playerView">
        <ng-container  *ngIf="!!init.ac">
          <mat-icon>shield</mat-icon>
          <span class="value">{{init.ac}}</span>
        </ng-container>
      </div>
    </div>
  </div>

  <div class="combat-wrapper" *ngIf="!playerView">
    <div class="characters-wrapper">

      <ng-container *ngFor="let character of playerCharacters; trackBy:trackInit">
        <ng-container *ngTemplateOutlet="entity; context: { entity: character }"></ng-container>
      </ng-container>
    </div>

    <div class="combat-actions-wrapper" *ngIf="!playerView">
      <div class="initiative-actions">
        <button mat-raised-button (click)="previousTurn()"><mat-icon>undo</mat-icon></button>
        <button mat-raised-button (click)="resetInitiative()"><mat-icon>restart_alt</mat-icon></button>
        <button mat-raised-button (click)="nextTurn()"><mat-icon>redo</mat-icon></button>
      </div>

      <button mat-raised-button (click)="openSaveEncounterDialog()"><mat-icon>save</mat-icon></button>

      <mat-accordion>
        <mat-expansion-panel hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title>
              Saved encounters ({{stashedEncounters?.length || 0}})
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="saved-encounter" *ngFor="let stashed of stashedEncounters; let i = index" (click)="loadEncounter(stashed)">
            <span>{{stashed.name}}</span>
            <mat-icon color="warn" (click)="deleteSavedEncounter($event, i)">delete</mat-icon>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <div class="monsters-wrapper">
      <ng-container *ngFor="let monster of monsters; index as index; trackBy:trackInit">
        <ng-container *ngTemplateOutlet="entity; context: { entity: monster, index: index }"></ng-container>
      </ng-container>
    </div>

  </div>

  <div class="logs-wrapper mat-elevation-z8" [ngClass]="{'show-logs': showLogs}">
    <div class="log" *ngFor="let log of combatLog">
      <mat-icon>lens_blur</mat-icon>{{log}}
    </div>
  </div>
</div>

<ng-template #entity let-entity="entity" let-index="index">
  <div class="mat-elevation-z8" [ngClass]="entity.isPC? 'character': 'monster'">
    <div class="image">
      <ng-container *ngIf="entity.isPC">
        <img [src]="'assets/images/dnd/player-characters/' + entity.code + '.png'" />
      </ng-container>
      <ng-container *ngIf="!entity.isPC">
        <img [src]="'assets/images/dnd/player-characters/' + (!!entity.monsterType? entity.monsterType: 'monster') + '.png'" />
      </ng-container>

      <button *ngIf="!entity.isPC" class="icon-remove" mat-icon-button (click)="removeMonster(index)"><mat-icon>delete</mat-icon></button>
    </div>
    <div class="info">
      <div class="name">
        <ng-container *ngIf="entity.isPC">{{entity.name}}</ng-container>
        <ng-container *ngIf="!entity.isPC">

          <mat-form-field appearance="outline">
            <input matInput [(ngModel)]="entity.name" class="input-name" (change)="update()" (focus)="onFocus($event)"/>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-select class="ddl-monster" [(ngModel)]="entity.monsterType" (selectionChange)="monsterSelected($event, entity, index)">
              <mat-option *ngFor="let monster of humblewoodMonsters" [value]="monster.code">{{monster.name}}</mat-option>
            </mat-select>
          </mat-form-field>

        </ng-container>
      </div>
      <div class="hp-meter mat-elevation-z8" [ngClass]="{'is-blooded': (entity.currentHPs / entity.maxHPs) <= 0.5, 'is-dead': entity.currentHPs <= 0}">
        <div class="current-hp-meter" [ngStyle]="{'width': (entity.currentHPs / entity.maxHPs) * 100 + '%'}"></div>
        <div class="temp-hp-meter" [ngStyle]="{'width': (entity.tempHPs / entity.maxHPs) * 100 + '%'}"></div>
      </div>
    </div>
    <div class="control-panel">
      <div class="record">
        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="entity.initiative" type="number" (change)="update()" (focus)="onFocus($event)"/>
          <mat-icon matSuffix class="icon-initiative">flash_on</mat-icon>
        </mat-form-field>


        <mat-form-field appearance="outline">
          <input matInput [(ngModel)]="entity.ac" type="number" (change)="update()" (focus)="onFocus($event)" />
          <mat-icon matSuffix class="icon-ac">shield</mat-icon>
        </mat-form-field>
      </div>
      <div class="record">
        <mat-form-field appearance="outline">
          <input matInput [value]="entity.currentHPs" (change)="hpChange($event, entity)" (focus)="onFocus($event)"/>
          <mat-icon matSuffix class="icon-hps">favorite</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <input matInput [value]="entity.maxHPs" type="number" (change)="maxHpChange($event, entity)" (focus)="onFocus($event)" />
          <mat-icon matSuffix class="icon-max-hps">favorite</mat-icon>
        </mat-form-field>

      </div>
      <div class="record">
        <mat-form-field appearance="outline">
          <input matInput type="number" [(ngModel)]="entity.tempHPs" (change)="update()" (focus)="onFocus($event)"/>
          <mat-icon matSuffix class="icon-temp-hp">heart_broken</mat-icon>
        </mat-form-field>

        <mat-icon *ngIf="!entity.isPC" color="primary" class="cursor-pointer" (click)="duplicate(entity)">content_copy</mat-icon>
      </div>
    </div>
    <div class="notes" *ngIf="!entity.isPC">
      <mat-form-field appearance="outline">
        <textarea matInput [(ngModel)]="entity.notes" class="input-notes" (change)="update()" (focus)="onFocus($event)"></textarea>
      </mat-form-field>
    </div>
  </div>
</ng-template>
